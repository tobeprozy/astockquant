# qplot 插件重构方案

## 1. 当前结构分析

目前 qplot 插件存在以下问题：

1. **结构不够清晰**：当前按图表类型（K线图、分时图）组织代码，而非按绘图库组织
2. **重复代码较多**：不同绘图库和不同图表类型之间存在大量重复逻辑
3. **接口不统一**：需要针对不同图表类型调用不同的绘图函数
4. **扩展困难**：添加新的绘图库或图表类型需要修改多处代码

## 2. 重构目标

1. 让不同的绘图库（如 matplotlib、pyecharts 等）独立开来
2. 统一处理不同类型的图表，消除日线图和分时图的区别
3. 提供一致的 API 接口，简化用户使用
4. 提高代码复用率和可扩展性

## 3. 重构方案

### 3.1 目录结构重构

重构后的目录结构将按绘图库类型组织：

```
qplot/
├── __init__.py          # 保持现有的公共 API
├── core/                # 核心功能模块
│   ├── __init__.py
│   ├── plotter.py       # 抽象基类定义
│   └── data_manager.py  # 数据管理相关功能
├── backends/            # 各绘图库后端实现
│   ├── __init__.py
│   ├── matplotlib/
│   │   ├── __init__.py
│   │   ├── chart.py     # 通用图表实现
│   │   └── utils.py     # matplotlib 工具函数
│   ├── pyecharts/
│   │   ├── __init__.py
│   │   ├── chart.py     # 通用图表实现
│   │   └── utils.py     # pyecharts 工具函数
│   └── ...              # 其他绘图库后端
└── utils/               # 公共工具函数
    ├── __init__.py
    └── data_processing.py
```

### 3.2 代码实现重构

1. **统一图表接口**
   - 创建一个通用的 `Chart` 类，继承自 `Plotter` 基类
   - 通过参数来控制绘制 K 线图还是分时图，而不是使用不同的类

2. **绘图库抽象**
   - 每个绘图库后端提供统一的接口实现
   - 使用工厂模式创建适合的绘图后端实例

3. **数据处理**
   - 将数据处理逻辑集中到 `utils/data_processing.py`
   - 提供统一的数据格式转换功能

### 3.3 API 统一

保留现有的 `plot_kline` 和 `plot_minute_chart` 函数以保证向后兼容，同时提供一个更通用的 `plot_chart` 函数。

## 4. 重构实现步骤

1. 创建新的目录结构
2. 实现核心抽象类和接口
3. 重构各绘图库的实现
4. 统一数据处理逻辑
5. 更新 API 和示例
6. 测试和验证

## 5. 兼容性考虑

- 保留现有的 API 接口以确保向后兼容
- 提供迁移指南，帮助用户过渡到新的 API
- 在文档中明确标记旧 API 的状态

---

让我们开始实施这个重构方案。